# JPX400スクリーニングシステム

JPX400銘柄のテクニカル分析と自動スクリーニングを行うアプリケーションです。

## ⚠️ 免責事項

**重要：このアプリケーションは投資判断の支援ツールであり、投資の推奨や助言を行うものではありません。**

- このアプリケーションが提供する情報（スクリーニング結果、チャート、分析データなど）は、あくまで参考情報として提供されるものです
- 実際の株式投資に関するすべての判断と行動は、**ユーザー自身の責任**において行ってください
- このアプリケーションを使用した結果、投資判断や取引によって生じた損害について、開発者および提供者は一切の責任を負いません
- 投資にはリスクが伴います。投資を行う前に、必ずご自身で十分な調査・検討を行い、リスクを理解した上で判断してください
- 過去のデータや分析結果が将来の投資成果を保証するものではありません

## 📋 このアプリケーションについて

このアプリケーションは、JPX400（日本取引所グループが選定した400銘柄）の株価データを自動で収集し、テクニカル分析を使って投資に役立つ銘柄を探すためのツールです。

**主な機能：**
- 株価データの自動収集
- テクニカル指標を使った銘柄のスクリーニング（選別）
  - 並列処理により高速化（5-10倍の処理速度向上）
  - ゴールデンクロス検出（5MA/25MA、25MA/75MA、5MA/200MA）
- チャート表示
- 市場の地合い（相場の雰囲気）を数値化

## 🆕 最近の更新
- **5MA/200MAのゴールデンクロス機能を追加**
  - 5日移動平均線と200日移動平均線のゴールデンクロスを検出する機能を追加
  - 既存の5MA/25MA、25MA/75MAのゴールデンクロスに加えて、より長期のトレンド転換点を捉えることが可能
  - スクリーニング条件として選択可能で、履歴にも正しく記録されます
- **スクリーニング処理の高速化（並列処理）**
  - マルチスレッド並列処理により、スクリーニング処理を5-10倍高速化
  - CPUコア数に応じて自動的に最適なスレッド数を使用
  - 設定ファイル（`config/screening.yaml`）で並列処理の有効/無効とスレッド数を制御可能
  - MACD/KDフィルタが無効な場合は計算をスキップして処理速度を向上
- **スクリーニング条件「直近2日が5MAの上で陽線」の修正**
  - 今日のデータが仮終値として存在する場合、それが陰線なら条件を満たさないように修正
  - 今日のデータが仮終値で陽線の場合、今日と昨日で判定するように改善
  - これにより、取引時間中や取引終了直後にスクリーニングを実行した場合でも、正確な結果が得られるようになりました
- **勝率計算の営業日除外修正**
  - 全銘柄とスクリーニング結果の勝率計算で、土日など取引がない日を除外するように修正
  - 実際にDBにデータが存在する日付のみを考慮するように改善
  - これにより、0/1のような誤った勝率結果が表示される問題を解消しました
- **財務指標表示機能を追加**
  - スクリーニング結果一覧にPER、PBR、利回り、ROA、ROEを追加表示
  - 市況タブのセクター別銘柄一覧にも財務指標を追加表示
  - セクター・業種別の平均財務指標を表示（市況タブ）
  - Yahoo Financeから財務指標を自動取得・保存
  - 「財務指標を取得」ボタンで一括取得可能
  - **財務指標の自動取得機能を追加**
    - 毎日0:00に自動で財務指標を取得
    - 「財務指標を取得」ボタンの横に最新実施日時を表示
- **スクリーニング履歴に全銘柄パフォーマンス比較機能を追加**
  - スクリーニング履歴一覧で、日付が変わるタイミングに全銘柄（JPX400全体）のパフォーマンス行を表示
  - スクリーニング結果と全銘柄のパフォーマンスを比較することで、スクリーニングの有効性を評価可能
  - 全銘柄パフォーマンスデータはデータベースに保存され、次回以降は計算をスキップして高速表示
  - 正式データのみを使用して計算（仮終値データは除外）
  - デバッグ用に「全銘柄勝率再計算(debug用)」ボタンを追加
- スクリーニング履歴一覧で、翌1/2/3営業日の勝率・平均騰落率・中央値を表示できるようにし、履歴ウィンドウを横長に拡大
- 履歴のスクリーニング結果でも翌日以降の騰落率を確認可能（履歴詳細ウィンドウ）
- 地合いスコアのパラメータ一覧タブで、重み付けバージョンのプルダウンが常に最新バージョンを指すように改善
- データ収集時は銘柄名更新を行わず、専用の「銘柄名取得」ボタンでのみ更新するように分離

## ⭐ スターのお願い

このプロジェクトが役に立ったと感じていただけましたら、GitHubでスター（⭐）を付けていただけると、作者の励みになります！

---

## 🖥️ 必要なもの

### パソコンの環境

- **OS（オペレーティングシステム）**: Windows 10/11、Mac、Linuxのいずれか
- **メモリ**: 4GB以上（8GB以上推奨）
- **空き容量**: 2GB以上
- **インターネット接続**: 必須（株価データを取得するため）

### 必要なソフトウェア

1. **Python（パイソン）** というプログラミング言語
   - バージョン3.8以上が必要です（3.10以上を推奨）
   - まだインストールしていない場合は、後述の「Pythonのインストール方法」を参照してください
   - **これだけインストールすれば、`直接起動.bat`で自動的に必要なパッケージがインストールされます**

**注意：**
- 仮想環境（venv）の作成は**必須ではありません**
- `直接起動.bat`を使う場合、仮想環境がなくても動作します（システムPythonを使用）

---

## 📥 インストール手順（初めて使う場合）

### 🚀 簡単な方法（推奨）：直接起動.batを使う場合

**最も簡単な方法です。** 以下の手順で起動できます：

1. **Pythonがインストールされていることを確認**（ステップ1を参照）
2. **プロジェクトファイルをダウンロード**（ステップ2を参照）
3. **`dist/直接起動.bat`をダブルクリック**
   - 初回起動時、必要なパッケージがインストールされていない場合、インストール確認メッセージが表示されます
   - 「Y」と入力してEnterキーを押すと、自動でパッケージがインストールされます
   - アプリケーションが起動します
4. **次回以降も同じく`dist/直接起動.bat`をダブルクリックするだけ**

**重要：**
- 初回起動後は、「初回セットアップ」の手順（JPX400リスト更新、銘柄名取得、データ収集）を実行する必要があります
- 詳細は「📊 初回セットアップ（最初に1回だけ行う作業）」セクションを参照してください

**注意：**
- 仮想環境（venv）の作成は**必須ではありません**（`直接起動.bat`が自動で対応します）
- 仮想環境がない場合は、システムPythonを使用します
- システムPythonを使用する場合、必要なパッケージが自動的にインストールされます

---

### 📋 詳細な手順（上級者向け・仮想環境を使う場合）

仮想環境を作成して、より安全にパッケージを管理したい場合は、以下の手順に従ってください。

### ステップ1: Pythonがインストールされているか確認する

まず、Pythonがインストールされているか確認します。

#### Windowsの場合

1. **コマンドプロンプト**を開きます
   - Windowsキーを押して「cmd」と入力
   - 「コマンドプロンプト」をクリック
   - または、Windowsキー + R を押して「cmd」と入力してEnter

2. コマンドプロンプトに以下の文字を入力してEnterキーを押します：
   ```
   python --version
   ```

3. 以下のような表示が出ればOKです：
   ```
   Python 3.10.0
   ```
   （数字は異なっても構いません。3.8以上であれば問題ありません）

4. もし「'python' は、内部コマンドまたは外部コマンド、操作可能なプログラムまたはバッチ ファイルとして認識されていません。」と表示された場合は、Pythonがインストールされていません。次の「Pythonのインストール方法」を参照してください。

#### Macの場合

1. **ターミナル**を開きます
   - アプリケーション → ユーティリティ → ターミナル
   - または、Spotlight検索（Command + Space）で「ターミナル」と入力

2. ターミナルに以下の文字を入力してEnterキーを押します：
   ```
   python3 --version
   ```

3. バージョン番号が表示されればOKです

#### Pythonがインストールされていない場合

**Windowsの場合：**
1. ブラウザで https://www.python.org/downloads/ を開く
2. 「Download Python 3.x.x」（最新版）をクリックしてダウンロード
3. ダウンロードしたファイルを実行
4. インストール画面で「Add Python to PATH」にチェックを入れる（重要！）
5. 「Install Now」をクリック
6. インストールが完了したら、コマンドプロンプトを再起動して再度確認

**Macの場合：**
1. ブラウザで https://www.python.org/downloads/ を開く
2. 「Download Python 3.x.x」（最新版）をクリックしてダウンロード
3. ダウンロードしたファイルを実行してインストール

---

### ステップ2: プロジェクトファイルを取得する

このアプリケーションのファイルをパソコンにダウンロードします。

#### 方法1: ZIPファイルをダウンロードする場合（簡単）

1. プロジェクトのZIPファイルをダウンロード
2. ZIPファイルを右クリック → 「すべて展開」または「展開」
3. 展開したフォルダを覚えやすい場所（例：デスクトップ、ドキュメントフォルダ）に移動

#### 方法2: Gitを使う場合（上級者向け）

Gitがインストールされている場合：
```
git clone <リポジトリURL>
cd jpx400screener
```

---

### ステップ3: 仮想環境を作る（推奨・任意）

**仮想環境とは？**
- このアプリケーション専用のPython環境を作ることです
- 他のアプリケーションに影響を与えずに、必要なパッケージをインストールできます
- 初心者の方でも、この手順に従えば簡単にできます

**重要：** 仮想環境の作成は**必須ではありません**。`直接起動.bat`を使う場合は、このステップをスキップしても問題ありません。仮想環境がない場合、`直接起動.bat`は自動的にシステムPythonを使用します。

#### Windowsの場合

1. **コマンドプロンプト**を開きます（ステップ1を参照）

2. プロジェクトフォルダに移動します
   - 例えば、プロジェクトフォルダが「C:\Users\あなたの名前\Desktop\jpx400screener」にある場合：
   ```
   cd C:\Users\あなたの名前\Desktop\jpx400screener
   ```
   - または、エクスプローラーでプロジェクトフォルダを開き、アドレスバーに「cmd」と入力してEnterキーを押すと、そのフォルダでコマンドプロンプトが開きます

3. 以下のコマンドを入力してEnterキーを押します：
   ```
   python -m venv venv
   ```
   - 少し時間がかかります（30秒～1分程度）
   - エラーが出なければ成功です

4. 仮想環境を有効化します：
   ```
   venv\Scripts\activate
   ```
   - 成功すると、コマンドプロンプトの先頭に `(venv)` と表示されます
   - これが表示されていれば、仮想環境が有効になっています

#### Macの場合

1. **ターミナル**を開きます

2. プロジェクトフォルダに移動します：
   ```
   cd ~/Desktop/jpx400screener
   ```
   （実際のフォルダの場所に合わせて変更してください）

3. 以下のコマンドを入力してEnterキーを押します：
   ```
   python3 -m venv venv
   ```

4. 仮想環境を有効化します：
   ```
   source venv/bin/activate
   ```
   - 成功すると、ターミナルの先頭に `(venv)` と表示されます

**重要：** 仮想環境を有効化すると、プロンプトの先頭に `(venv)` と表示されます。これが表示されている間は、仮想環境が有効になっています。

---

### ステップ4: 必要なパッケージをインストールする

**パッケージとは？**
- アプリケーションが動作するために必要な追加のプログラムです
- インターネットから自動でダウンロードしてインストールします

1. **仮想環境が有効になっていることを確認**します
   - コマンドプロンプト（またはターミナル）の先頭に `(venv)` と表示されていることを確認
   - 表示されていない場合は、ステップ3の「仮想環境を有効化」を再度実行してください

2. 以下のコマンドを入力してEnterキーを押します：
   ```
   pip install -r requirements.txt
   ```
   - これには5分～10分程度かかることがあります
   - たくさんのメッセージが表示されますが、これは正常です
   - 最後に「Successfully installed」と表示されれば成功です

**インストールされる主なパッケージ：**
- `yfinance`: 株価データを取得するためのパッケージ
- `pandas`: データを処理するためのパッケージ
- `numpy`: 数値計算を行うためのパッケージ
- `matplotlib`: グラフを描画するためのパッケージ
- `apscheduler`: 自動実行機能に必要なパッケージ（**重要**）
- `deep-translator`: 銘柄名とセクター名の翻訳に使用するパッケージ（**重要**）
- `pdfplumber`: JPX400銘柄リスト取得時にPDFを解析するためのパッケージ（**重要**）

**エラーが出た場合：**
- インターネット接続を確認してください
- コマンドプロンプト（ターミナル）を閉じて、再度開いてからやり直してください
- それでも解決しない場合は、「トラブルシューティング」セクションを参照してください

**重要：データベースについて**
- アプリケーションを起動すると、`data`フォルダと`data/tick_data.db`（SQLite3データベースファイル）が自動的に作成されます
- データベースの作成や初期化は手動で行う必要はありません
- 初回起動時は空のデータベースが作成され、その後「初回セットアップ」の手順でデータを追加していきます

---

## 🚀 アプリケーションの起動方法

### 方法1: 簡単な起動方法（Windows推奨・最も簡単）

1. プロジェクトフォルダの中の `dist` フォルダを開きます
2. `直接起動.bat` というファイルを**ダブルクリック**します
   - これで自動的にアプリケーションが起動します
   - 仮想環境も自動で検出されます（なければシステムPythonを使用）

**動作の詳細：**
- **初回起動時**：
  - 仮想環境（`venv`または`.venv`）があれば自動で使用します
  - 仮想環境がない場合は、システムPythonを使用します
  - 必要なパッケージ（pandasなど）がインストールされていない場合、インストール確認メッセージが表示されます
  - 「Y」と入力してEnterキーを押すと、自動で`pip install -r requirements.txt`が実行され、パッケージがインストールされます
  - インストール完了後、アプリケーションが起動します
- **2回目以降の起動**：
  - `直接起動.bat`をダブルクリックするだけで起動します
  - パッケージのインストール確認は表示されません（既にインストール済みのため）

**注意：**
- 仮想環境の作成は**必須ではありません**。`直接起動.bat`が自動で対応します
- システムPythonを使用する場合でも、必要なパッケージは自動的にインストールされます

### 方法2: コマンドから起動する場合

#### Windowsの場合

1. **コマンドプロンプト**を開きます
2. プロジェクトフォルダに移動します：
   ```
   cd C:\Users\あなたの名前\Desktop\jpx400screener
   ```
3. 仮想環境を有効化します（まだ有効化していない場合）：
   ```
   venv\Scripts\activate
   ```
4. アプリケーションを起動します：
   ```
   python run_control_panel.py
   ```

#### Macの場合

1. **ターミナル**を開きます
2. プロジェクトフォルダに移動します：
   ```
   cd ~/Desktop/jpx400screener
   ```
3. 仮想環境を有効化します：
   ```
   source venv/bin/activate
   ```
4. アプリケーションを起動します：
   ```
   python run_control_panel.py
   ```

**アプリケーションが起動すると：**
- ウィンドウが開き、「JPX400スクリーニング コントロールパネル」という画面が表示されます
- **この時点で、`data`フォルダと`data/tick_data.db`データベースファイルが自動的に作成されています**
- これで準備完了です！次は「初回セットアップ」の手順に進んでください

---

## 📊 初回セットアップ（最初に1回だけ行う作業）

アプリケーションを初めて起動したら、以下の手順でデータを準備します。

### 0. アプリケーションを起動する（重要）

**重要：** アプリケーションを起動すると、以下の処理が自動的に行われます：

- **`data`フォルダの自動作成**: プロジェクトフォルダ内に`data`フォルダが自動的に作成されます
- **データベースファイルの自動作成**: `data/tick_data.db`というSQLite3データベースファイルが自動的に作成されます
- **データベーステーブルの自動初期化**: 必要なテーブル構造（銘柄情報テーブル、株価データテーブルなど）が自動的に作成されます

**つまり、データベースの作成は手動で行う必要はありません。** アプリケーションを起動するだけで、データベースは自動的に準備されます。

**確認方法：**
- アプリケーションを起動した後、プロジェクトフォルダ内に`data`フォルダが作成されていることを確認してください
- `data/tick_data.db`ファイルが存在することを確認してください（ファイルサイズは0バイトでも問題ありません）
- `data/jpx400_symbols.json`ファイルが作成されていることを確認してください（初回起動時は10銘柄のサンプルリストが含まれています）

**重要：** 初回起動時は、`data/jpx400_symbols.json`に10銘柄のサンプルリストが自動的に作成されます。実際のJPX400銘柄リスト（約400銘柄）に更新する必要があります。次のステップで更新します。

### 1. データ管理タブを開く

起動したアプリケーションの画面で、「データ管理」というタブをクリックします。

### 2. JPX400リストを更新する（重要）

**目的：** JPX400に含まれる銘柄コード（例：7203、6758など）のリストを取得します。

**重要：** 初回起動時は、10銘柄のサンプルリストが自動的に作成されます。実際のJPX400銘柄リスト（約400銘柄）に更新する必要があります。

**手順：**

1. 「**JPX400リスト更新**」ボタンをクリックします
2. ダイアログが表示されます：
   - **「はい」を選択**：JPX公式サイトから自動で取得（推奨）
   - **「いいえ」を選択**：CSVファイルから読み込み
   - **「キャンセル」を選択**：処理をキャンセル
3. 「はい」を選択した場合：
   - 自動的にJPX公式サイトから銘柄リストを取得します
   - 取得に失敗した場合（300銘柄未満）は、CSVファイルからの読み込みを提案されます
   - CSVファイルを選択すると、そのファイルから銘柄リストを読み込みます
4. 「いいえ」を選択した場合：
   - CSVファイルを選択するダイアログが表示されます
   - JPX400銘柄リストのCSVファイルを選択してください
   - CSVファイルの形式：銘柄コードが最初の列にある形式（例：`7203,トヨタ自動車,...`）
5. 確認ダイアログで「はい」をクリックすると、リストが更新されます
6. 完了メッセージが表示されます（約400銘柄が表示されれば成功です）

**注意：**
- この作業は銘柄コードのリストを更新するだけで、銘柄名は取得しません
- 次のステップで銘柄名を取得します
- 初回起動時に作成される10銘柄のサンプルリストは、実際のJPX400銘柄リストではありません
- データ収集を行う前に、必ずJPX400リストを更新してください

### 3. 銘柄名を取得する

**目的：** 各銘柄コードに対応する銘柄名（会社名）とセクター情報を取得します。

**手順：**

1. 「**銘柄名取得**」ボタンをクリックします（「JPX400リスト更新」ボタンの右隣にあります）
2. 確認ダイアログが表示されます：
   - 「はい」をクリックすると処理を開始します
   - 「いいえ」をクリックするとキャンセルします
3. 処理が開始されると：
   - データベースに保存されている全銘柄の銘柄名を取得します
   - 英語名を自動的に日本語に翻訳します
   - セクター情報も同時に取得・翻訳します
4. 進行状況が表示されます：
   - 画面下部のステータスバーに「状態: 銘柄名取得中... (現在の数/全体の数)」と表示されます
   - 各銘柄の処理状況が表示されます
5. **これには数分～十数分かかることがあります**（銘柄数によります）
6. 完了メッセージが表示されます：
   - 成功した銘柄数
   - スキップされた銘柄数（既に名前がある銘柄）
   - エラーが発生した銘柄数

**注意：**
- 既に銘柄名が保存されている銘柄は自動的にスキップされます
- インターネット接続が必要です（Yahoo Financeから情報を取得します）
- 翻訳機能を使用するため、`deep-translator`パッケージがインストールされている必要があります

**翻訳機能について：**
- 英語の銘柄名は自動的に日本語に翻訳されます
- セクター名も日本語に翻訳されます
- 翻訳に失敗した場合は、英語名がそのまま使用されます

### 4. 株価データを収集する

**目的：** 各銘柄の過去の株価データ（日足データ）を取得します。

**手順：**

1. 「**JPX400データ収集**」ボタンをクリックします
2. 確認ダイアログが表示されます：
   - 「はい」をクリックすると処理を開始します
   - 「いいえ」をクリックするとキャンセルします
3. 処理が開始されると：
   - 過去の株価データが一括で収集されます
   - 当日の始値・終値は1分足データから取得し、仮終値として保存します
4. 進行状況が表示されます：
   - 画面下部のステータスバーに進捗状況が表示されます
   - 各銘柄の処理状況が表示されます
5. **これには10分～30分程度かかります**（銘柄数とネットワーク状況によります）
6. 完了メッセージが表示されます

**重要：**
- データ収集中は、アプリケーションを閉じないでください
- インターネット接続が必要です
- 途中でエラーが出た場合は、「データ収集を停止」ボタンをクリックして、後で再開できます
- 自動実行機能が有効な場合、15:00と20:00に自動でデータ収集が実行されます

### 5. 完了の確認

データ収集が完了すると、`data/tick_data.db` データベースファイルに株価データが保存されます。

**確認方法：**
- 「**DB銘柄一覧**」ボタンをクリックすると、データベースに保存されている全銘柄の情報を確認できます
- 銘柄名、セクター情報、統計情報などが表示されます

**注意：**
- データベースファイル（`data/tick_data.db`）は、アプリケーション起動時に自動的に作成されています
- データ収集を実行すると、このデータベースファイルに株価データが追加されます

---

## 🔄 アプリケーションの更新方法

リポジトリが更新された場合、以下の手順でプログラムを更新できます。

### 更新前の注意事項

- **データベースファイルは保護されています**
  - `data/tick_data.db` は自動的に保護され、上書きされません
  - 既存のデータ（銘柄データ、スクリーニング履歴など）はそのまま保持されます
  - プログラム起動時に、必要なデータベース構造の更新が自動的に行われます

### 更新手順

#### 方法1: Gitを使っている場合（推奨）

1. **コマンドプロンプト（ターミナル）を開きます**
   - Windows: コマンドプロンプト
   - Mac/Linux: ターミナル

2. **プロジェクトフォルダに移動します**
   ```
   cd C:\Users\あなたの名前\Desktop\jpx400screener
   ```
   （実際のフォルダの場所に合わせて変更してください）

3. **最新の変更を取得します**
   ```
   git pull
   ```

4. **アプリケーションを起動します**
   - `dist/直接起動.bat` をダブルクリック
   - または `python run_control_panel.py`

**完了！** プログラムが最新版に更新され、既存のデータはそのまま使用できます。

#### 方法2: ZIPファイルをダウンロードした場合

1. **現在のプロジェクトフォルダをバックアップします**（念のため）
   - `data` フォルダを別の場所にコピーしておくと安心です

2. **GitHubから最新版をダウンロードします**
   - リポジトリのページから「Code」→「Download ZIP」をクリック

3. **新しいZIPファイルを展開します**
   - 既存のフォルダとは別の場所に展開してください

4. **`data` フォルダを新しいフォルダにコピーします**
   - バックアップした `data` フォルダを、新しいプロジェクトフォルダにコピーします
   - これで既存のデータが引き継がれます

5. **アプリケーションを起動します**
   - 新しいフォルダの `dist/直接起動.bat` をダブルクリック

### 更新後の確認

- アプリケーションを起動すると、必要に応じてデータベース構造が自動的に更新されます
- 初回起動時に「○○列を追加しました」というメッセージが表示されることがありますが、これは正常な動作です
- 既存のデータはそのまま使用できます

### トラブルシューティング

**Q: 更新後にエラーが発生する**
- 仮想環境を再作成してみてください：
  ```
  # 既存のvenvフォルダを削除
  # その後、インストール手順の「ステップ3: 仮想環境を作る」からやり直してください
  ```

**Q: データが消えた**
- `data` フォルダが正しくコピーされているか確認してください
- バックアップから `data` フォルダを復元してください

---

## 🎯 主な機能の使い方

### 1. データ管理

#### JPX400データ収集
- 最新の株価データを取得します
- 通常は自動で実行されますが、手動でも実行できます

#### JPX400リスト更新
- JPX400の構成銘柄が変更された場合に、最新のリストを取得します
- 四半期ごと（3ヶ月ごと）に実行することをおすすめします

#### 銘柄名取得
- 銘柄コードから銘柄名とセクター情報を取得します
- 初回セットアップ時と、新しい銘柄が追加された時に実行します

#### DB銘柄一覧
- データベースに保存されている全銘柄の情報を表示します
- 銘柄をダブルクリックすると、チャートが表示されます
- 銘柄を右クリックすると、以下のメニューが表示されます：
  - **株探で開く**: 選択した銘柄の株探ページをブラウザで開きます
  - **バフェット・コードで開く**: 選択した銘柄のバフェット・コードページをブラウザで開きます

### 2. スクリーニング機能

スクリーニングとは、条件に合う銘柄を自動で探す機能です。

#### テクニカル条件の設定

以下のような条件を設定できます：

- **移動平均線順序**: 短期の移動平均線が長期の移動平均線より上にある（上昇トレンド）
- **陽線連続**: 直近の数日間が連続して上昇している
- **移動平均線上向き**: 移動平均線が上向きになっている
- **ゴールデンクロス**: 短期の移動平均線が長期の移動平均線を上抜けした
  - **5MA/25MAゴールデンクロス**: 短期トレンドの転換点を捉える
  - **25MA/75MAゴールデンクロス**: 中期トレンドの転換点を捉える
  - **5MA/200MAゴールデンクロス**: 長期トレンドの転換点を捉える（新規追加）
  - 各ゴールデンクロスについて、「直近でクロス」または「クロス中」の2つの判定モードを選択可能
- **MACD/KDシグナル**: テクニカル指標の買いシグナルが出ている

#### スクリーニングの実行

1. 「スクリーニング」タブを開きます
2. 条件を設定します
3. 「スクリーニング実行」ボタンをクリックします
4. **並列処理により高速に処理されます**（デフォルトで有効、CPUコア数に応じて自動最適化）
5. 条件に合う銘柄が一覧表示されます
6. **スクリーニング結果には財務指標（PER、PBR、利回り、ROA、ROE）も表示されます**
7. 銘柄を右クリックすると、以下のメニューが表示されます：
   - **株探で開く**: 選択した銘柄の株探ページをブラウザで開きます
   - **バフェット・コードで開く**: 選択した銘柄のバフェット・コードページをブラウザで開きます

**パフォーマンスについて：**
- スクリーニング処理は並列処理により高速化されています（デフォルトで有効）
- 400銘柄のスクリーニングが数分で完了します（CPUコア数に依存）
- 並列処理の設定は`config/screening.yaml`で変更可能です

#### スクリーニング履歴

過去のスクリーニング結果を保存して、後で確認できます。
- スクリーニングした時の株価と現在の株価を比較できます
- どの条件が有効だったかを検証できます
- **全銘柄パフォーマンス比較機能**
  - スクリーニング履歴一覧で、日付が変わるタイミングに全銘柄（JPX400全体）のパフォーマンス行が表示されます
  - 全銘柄行は薄いグレー背景で表示され、以下の情報が表示されます：
    - 実行日時: 「全銘柄(YYYY/MM/DD)」
    - 銘柄数: 「全銘柄」
    - 条件: 「-」
    - +1日勝率、+1日平均、+1日中央値
    - +2日勝率、+2日平均、+2日中央値
    - +3日勝率、+3日平均、+3日中央値
  - スクリーニング結果と全銘柄のパフォーマンスを比較することで、スクリーニング条件の有効性を評価できます
  - 全銘柄パフォーマンスデータはデータベースに保存され、次回以降は計算をスキップして高速に表示されます
  - 計算時は正式データのみを使用します（仮終値データは除外）
- **デバッグ機能**
  - 「全銘柄勝率再計算(debug用)」ボタンで、既存の全銘柄パフォーマンスデータを削除して再計算できます
  - データに問題がある場合や、計算ロジックを変更した場合に使用します

### 3. チャート表示

銘柄のチャート（グラフ）を表示できます。

#### 表示できるもの

- **ローソク足チャート**: 日足、週足、月足を切り替え可能
- **移動平均線**: 5日、25日、75日、200日の移動平均線
- **MACD**: テクニカル指標の1つ
- **KD**: テクニカル指標の1つ
- **出来高**: 取引量のグラフ

#### 操作方法

- **マウスホイール**: チャートを拡大・縮小
- **ドラッグ**: チャートを左右に移動
- **マウスを動かす**: 価格と日付を確認

### 4. 地合いスコア機能

市場全体の雰囲気（地合い）を数値化する機能です。

#### 地合いスコア算出

- 日経平均、TOPIX、JPX400などの市場指標から地合いを数値化します
- 推奨実行時刻: 朝8:45～8:55（市場が開く前）

#### 市場動向記録・評価

- 前日の地合いスコアと実際の市場動向を比較します
- スコアの精度を評価・改善します
- 推奨実行時刻: 15:40（市場が閉じた後）

### 5. 市況タブ（セクター資金流動分析）

セクターごとの資金の流れを可視化する機能です。

#### セクター資金流動分析

- 各セクターの売買代金（終値 × 出来高）を日次で集計・表示します
- セクターごとの資金シフトの様子をグラフで確認できます
- 以下のグラフタイプを選択できます：
  - **売買代金**: セクター別の売買代金推移（線グラフ）
  - **前日比**: 前日からの変化率（%）
  - **移動平均**: 売買代金の移動平均線（トレンド把握に便利）
  - **積み上げ棒グラフ**: 日次でのセクター別売買代金の積み上げ表示
  - **シェア（積み上げ）**: 全売買代金に占める各セクターの割合（積み上げエリアチャート）
  - **1銘柄あたり売買代金**: セクター別の1銘柄あたり売買代金推移（銘柄数の偏りを補正した比較が可能）
  - **1銘柄あたり売買代金（移動平均）**: 1銘柄あたり売買代金の移動平均線
- 表示期間を選択できます（全期間、7日、30日、60日、90日、180日）
- 移動平均期間を選択できます（5日、10日、20日、30日、60日）

#### セクター別登録銘柄数

- セクターごとの登録銘柄数を表示します
- **各セクター・業種の平均財務指標（平均PER、平均PBR、平均利回り、平均ROA、平均ROE）も表示されます**
- セクター行をクリックすると、そのセクターに属する業種が展開/折りたたみされます（アコーディオン表示）
- セクター行をダブルクリックすると、そのセクターの銘柄一覧が表示されます
- 業種行をダブルクリックすると、そのセクター・業種の銘柄一覧が表示されます
- 初期表示でセクター全体が表示できるように、高さが自動調整されます

#### セクター別銘柄一覧

- セクターまたはセクター・業種を選択して、そのセクター（業種）に属する銘柄一覧を表示できます
- 銘柄の詳細情報（現在株価、最新出来高、データ件数など）を確認できます
- **財務指標（PER、PBR、利回り、ROA、ROE）も表示されます**
- 銘柄をダブルクリックすると、チャートが表示されます
- 銘柄を右クリックすると、以下のメニューが表示されます：
  - **株探で開く**: 選択した銘柄の株探ページをブラウザで開きます
  - **バフェット・コードで開く**: 選択した銘柄のバフェット・コードページをブラウザで開きます

#### 財務指標の取得と表示

- **財務指標を取得**: 市況タブの「財務指標を取得」ボタンで、全JPX400銘柄の財務指標を一括取得できます
- **自動取得**: 毎日0:00に自動で財務指標を取得します（アプリケーションを起動したままにしておく必要があります）
- **最新実施日時**: 「財務指標を取得」ボタンの横に、最新の実施日時が表示されます
- **セクター・業種別平均**: セクター別登録銘柄数に、各セクター・業種の平均PER、平均PBR、平均利回り、平均ROA、平均ROEが表示されます
- **銘柄別表示**: スクリーニング結果やセクター別銘柄一覧で、各銘柄の財務指標を確認できます

---

## ⏰ 自動実行機能

アプリケーションを起動したままにしておくと、以下の作業が自動で実行されます。

| タスク | 実行時刻 | 内容 |
|--------|----------|------|
| 財務指標取得 | 0:00 | 全銘柄の財務指標（PER、PBR、利回り、ROA、ROE）を取得 |
| 地合いスコア算出 | 8:50 | 当日の市場見通しを算出 |
| JPXデータ収集（15時） | 15:00 | 当日の仮終値を含むデータ更新 |
| 市場動向記録・評価 | 15:40 | 前日スコアの答え合わせ |
| JPXデータ収集（20時） | 20:00 | 最終的な当日データを取得 |

**注意：**
- アプリケーションを起動したままにしておく必要があります
- 自動実行機能を使うには、`apscheduler`というパッケージがインストールされている必要があります
- インストールされていない場合、警告メッセージが表示されます（後述のトラブルシューティングを参照）

---

## ❓ よくある質問とトラブルシューティング

### Q0. データが取得できない

**原因：**
- データベースが作成されていない
- 初回セットアップが完了していない
- インターネット接続の問題

**解決方法：**

1. **データベースが作成されているか確認します**
   - プロジェクトフォルダ内に`data`フォルダが存在するか確認してください
   - `data/tick_data.db`ファイルが存在するか確認してください
   - 存在しない場合は、アプリケーションを起動してください（起動時に自動的に作成されます）

2. **初回セットアップが完了しているか確認します**
   - 「初回セットアップ」の手順を確認してください
   - 以下の手順を順番に実行してください：
     1. JPX400リスト更新
     2. 銘柄名取得
     3. JPX400データ収集

3. **インターネット接続を確認します**
   - Yahoo Financeからデータを取得するため、インターネット接続が必要です
   - ファイアウォールやプロキシの設定を確認してください

4. **エラーメッセージを確認します**
   - アプリケーションの画面下部のステータスバーにエラーメッセージが表示されることがあります
   - エラーメッセージの内容をメモしておいてください

### Q0-1. JPX400銘柄リストが10銘柄しか取得できない

**原因：**
- 初回起動時に10銘柄のサンプルリストが自動的に作成されます
- 実際のJPX400銘柄リスト（約400銘柄）に更新する必要があります

**解決方法：**

1. **「JPX400リスト更新」ボタンをクリックします**
   - データ管理タブを開きます
   - 「JPX400リスト更新」ボタンをクリックします

2. **更新方法を選択します**
   - **「はい」を選択**：JPX公式サイトから自動取得（推奨）
     - 自動的にJPX公式サイトから銘柄リストを取得します
     - 取得に失敗した場合（300銘柄未満）は、CSVファイルからの読み込みを提案されます
   - **「いいえ」を選択**：CSVファイルから読み込み
     - CSVファイルを選択するダイアログが表示されます
     - JPX400銘柄リストのCSVファイルを選択してください

3. **更新が完了したことを確認します**
   - 完了メッセージで約400銘柄が表示されれば成功です
   - `data/jpx400_symbols.json`ファイルを確認して、`count`が約400になっていることを確認してください

**注意：**
- 初回起動時に作成される10銘柄のサンプルリストは、実際のJPX400銘柄リストではありません
- データ収集を行う前に、必ずJPX400リストを更新してください

### Q0-2. JPX公式サイトからの取得に失敗する（0銘柄しか取得できない）

**原因：**
- PDF解析ライブラリ（`pdfplumber`）がインストールされていない可能性があります
- インターネット接続の問題
- JPX公式サイトのPDFのURLが変更された可能性

**解決方法：**

1. **PDF解析ライブラリがインストールされているか確認します**
   - コマンドプロンプト（ターミナル）を開きます
   - 以下のコマンドを実行します：
     ```
     pip list | findstr pdfplumber
     ```
     （Mac/Linuxの場合は `pip list | grep pdfplumber`）
   - `pdfplumber`が表示されない場合は、インストールが必要です

2. **PDF解析ライブラリをインストールします**
   - コマンドプロンプト（ターミナル）を開きます
   - プロジェクトフォルダに移動します
   - 仮想環境を有効化します（使用している場合）
   - 以下のコマンドを実行します：
     ```
     pip install pdfplumber
     ```
   - または、`requirements.txt`から再インストールします：
     ```
     pip install -r requirements.txt
     ```

3. **アプリケーションを再起動します**
   - アプリケーションを終了して、再度起動します
   - 「JPX400リスト更新」ボタンをクリックして、「はい」を選択します

4. **それでも失敗する場合**
   - CSVファイルから読み込む方法を使用してください
   - 「JPX400リスト更新」ボタンをクリックして、「いいえ」を選択します
   - JPX400銘柄リストのCSVファイルを選択します

### Q1. 「ModuleNotFoundError」というエラーが出る

**意味：** 必要なパッケージがインストールされていません。

**解決方法：**

1. コマンドプロンプト（ターミナル）を開きます
2. プロジェクトフォルダに移動します
3. 仮想環境を有効化します：
   - Windows: `venv\Scripts\activate`
   - Mac: `source venv/bin/activate`
4. 以下のコマンドを実行します：
   ```
   pip install -r requirements.txt
   ```

### Q2. 「No module named 'src'」というエラーが出る

**意味：** プロジェクトフォルダで実行していない可能性があります。

**解決方法：**

1. コマンドプロンプト（ターミナル）で、プロジェクトフォルダに移動していることを確認します
2. プロジェクトフォルダに移動します：
   ```
   cd jpx400screener
   ```
   （実際のフォルダ名に合わせて変更してください）
3. 再度、アプリケーションを起動します：
   ```
   python run_control_panel.py
   ```

### Q3. データ収集が途中で止まる

**原因：**
- インターネット接続が切れた
- Yahoo! FinanceのAPI制限に達した

**解決方法：**

1. インターネット接続を確認します
2. しばらく待ってから再実行します（API制限は時間が経つと解除されます）
3. 「データ収集を停止」ボタンをクリックして安全に停止し、後で再開します

### Q4. データベースが壊れた

**解決方法：**

1. アプリケーションを終了します
2. `data` フォルダの中の `tick_data.db` というファイルを削除します
   - Windows: エクスプローラーでファイルを右クリック → 削除
   - Mac: ファイルをゴミ箱に移動
3. アプリケーションを再起動します
   - 再起動時に、空のデータベースファイルが自動的に作成されます
4. 初回セットアップの手順を再度実行します
   - 「JPX400リスト更新」→「銘柄名取得」→「JPX400データ収集」の順に実行してください

### Q5. チャートが表示されない

**原因：** matplotlibというパッケージの問題の可能性があります。

**解決方法：**

1. コマンドプロンプト（ターミナル）を開きます
2. 仮想環境を有効化します
3. 以下のコマンドを実行します：
   ```
   pip uninstall matplotlib
   pip install matplotlib
   ```

### Q6. 「[警告] APSchedulerがインストールされていません」と表示される

**意味：** 自動実行機能に必要なパッケージがインストールされていません。

**解決方法：**

#### 仮想環境を使っている場合

1. コマンドプロンプト（ターミナル）を開きます
2. プロジェクトフォルダに移動します
3. 仮想環境を有効化します：
   - Windows: `venv\Scripts\activate`
   - Mac: `source venv/bin/activate`
   - 先頭に `(venv)` と表示されることを確認します
4. 以下のコマンドを実行します：
   ```
   pip install apscheduler
   ```
5. アプリケーションを再起動します

#### 仮想環境を使っていない場合

1. コマンドプロンプト（ターミナル）を開きます
2. 以下のコマンドを実行します：
   ```
   pip install apscheduler
   ```

#### インストールできたか確認する方法

以下のコマンドを実行します：
```
python -c "import apscheduler; print('APScheduler version:', apscheduler.__version__)"
```

バージョン番号が表示されれば成功です。

**正常に動作している場合の表示：**
アプリケーション起動時に、以下のようなメッセージが表示されます：
```
[自動実行] JPXデータ収集を15:00と20:00に設定しました
[自動実行] 地合いスコア算出を8:50に設定しました
[自動実行] 市場動向記録・評価を15:40に設定しました
[自動実行] スケジューラーを起動しました
```

### Q7. 文字化けが発生する（Windows）

**原因：** コマンドプロンプトの文字コード設定の問題です。

**解決方法：**

1. コマンドプロンプトを開きます
2. 以下のコマンドを実行します：
   ```
   chcp 65001
   ```
3. アプリケーションを起動します：
   ```
   python run_control_panel.py
   ```

**推奨：** `dist/直接起動.bat` を使うと、自動的に文字コードが設定されます。

### Q8. 仮想環境が見つからない

**意味：** 仮想環境が作成されていないか、別の場所にある可能性があります。

**解決方法：**

#### 仮想環境があるか確認する

**Windowsの場合：**
1. エクスプローラーでプロジェクトフォルダを開きます
2. `venv` というフォルダがあるか確認します
3. `venv` フォルダの中に `Scripts` フォルダがあるか確認します

**Macの場合：**
1. Finderでプロジェクトフォルダを開きます
2. `venv` というフォルダがあるか確認します
3. `venv` フォルダの中に `bin` フォルダがあるか確認します

#### 仮想環境を再作成する

1. 既存の `venv` フォルダを削除します（ある場合）
2. コマンドプロンプト（ターミナル）を開きます
3. プロジェクトフォルダに移動します
4. 仮想環境を作成します：
   - Windows: `python -m venv venv`
   - Mac: `python3 -m venv venv`
5. 仮想環境を有効化します：
   - Windows: `venv\Scripts\activate`
   - Mac: `source venv/bin/activate`
6. パッケージをインストールします：
   ```
   pip install -r requirements.txt
   ```

#### 現在使っているPythonの場所を確認する

以下のコマンドを実行すると、現在使っているPythonの場所が表示されます：
```
python -c "import sys; print(sys.executable)"
```

---

## 📁 プロジェクトのフォルダ構成

プロジェクトフォルダの中身は以下のようになっています：

```
jpx400screener/
├── run_control_panel.py            # アプリケーションを起動するファイル
├── requirements.txt                 # 必要なパッケージのリスト
├── README.md                        # このファイル（説明書）
├── config/                          # 設定ファイル
│   └── screening.yaml              # スクリーニング条件の設定
├── src/                            # アプリケーションのプログラム
│   ├── gui/                        # 画面表示に関するプログラム
│   ├── screening/                  # スクリーニング機能のプログラム
│   └── sentiment/                  # 地合いスコア機能のプログラム
├── data/                           # データベース（自動作成）
│   └── tick_data.db               # 株価データが保存されるファイル
├── logs/                           # ログファイル（自動作成）
└── dist/                           # 起動用ファイル
    └── 直接起動.bat                 # Windows用の簡単起動ファイル
```

**初心者の方へ：**
- 基本的には、`dist/直接起動.bat` をダブルクリックするだけで起動できます
- `src` フォルダや `config` フォルダの中身を変更する必要はありません（上級者向け）

---

## ⚙️ 設定ファイルについて

### config/screening.yaml

スクリーニング条件の詳細な設定を変更できます。

**主な設定項目：**

- **indicators**: テクニカル指標のパラメータ（MACD、Stochastic）
- **proximity**: MACD/KD近接フィルタの設定
- **performance**: 並列処理の設定（新規追加）
  - `use_parallel`: 並列処理を使用するか（true/false、デフォルト: true）
  - `max_workers`: 最大スレッド数（nullの場合はCPUコア数を使用）

**注意：** このファイルを変更する場合は、テキストエディタで開いて編集します。変更後は、アプリケーションを再起動する必要があります。

**初心者の方へ：**
- 基本的には、このファイルを変更する必要はありません
- デフォルトの設定で問題なく動作します
- 並列処理はデフォルトで有効になっており、特に設定変更なしで高速化の恩恵を受けられます

---

## 📝 更新履歴

### v1.15.0 (2025-12-24)
- **5MA/200MAのゴールデンクロス機能を追加**
  - 5日移動平均線と200日移動平均線のゴールデンクロスを検出する機能を追加
  - 既存の5MA/25MA、25MA/75MAのゴールデンクロスに加えて、より長期のトレンド転換点を捉えることが可能
  - スクリーニング条件として選択可能で、履歴にも正しく記録されます
- **スクリーニング処理の高速化（並列処理）**
  - マルチスレッド並列処理により、スクリーニング処理を5-10倍高速化
  - CPUコア数に応じて自動的に最適なスレッド数を使用
  - 設定ファイル（`config/screening.yaml`）で並列処理の有効/無効とスレッド数を制御可能
  - MACD/KDフィルタが無効な場合は計算をスキップして処理速度を向上
  - 進捗表示の更新頻度を最適化してUIの負荷を軽減

### v1.14.0 (2025-12-22)
- **スクリーニング条件「直近2日が5MAの上で陽線」の修正**
  - 今日のデータが仮終値として存在する場合、それが陰線なら条件を満たさないように修正
  - 今日のデータが仮終値で陽線の場合、今日と昨日で判定するように改善
  - これにより、取引時間中や取引終了直後にスクリーニングを実行した場合でも、正確な結果が得られるようになりました
- **勝率計算の営業日除外修正**
  - 全銘柄とスクリーニング結果の勝率計算で、土日など取引がない日を除外するように修正
  - 実際にDBにデータが存在する日付のみを考慮するように改善
  - これにより、0/1のような誤った勝率結果が表示される問題を解消しました

### v1.13.0 (2025-12-21)
- **財務指標表示機能を追加**
  - スクリーニング結果一覧にPER、PBR、利回り、ROA、ROEを追加表示
  - 市況タブのセクター別銘柄一覧にも財務指標を追加表示
  - セクター・業種別の平均財務指標を表示（市況タブ）
  - Yahoo Financeから財務指標を自動取得・保存
  - 「財務指標を取得」ボタンで一括取得可能
  - スクリーニング結果ウィンドウの幅を1800pxに拡大し、全列が表示されるように最適化
- **財務指標の自動取得機能を追加**
  - 毎日0:00に自動で財務指標を取得
  - 「財務指標を取得」ボタンの横に最新実施日時を表示

### v1.12.0 (2025-12-19)
- **スクリーニング履歴に全銘柄パフォーマンス比較機能を追加**
  - スクリーニング履歴一覧で、日付が変わるタイミングに全銘柄（JPX400全体）のパフォーマンス行を表示
  - スクリーニング結果と全銘柄のパフォーマンスを比較することで、スクリーニングの有効性を評価可能
  - 全銘柄パフォーマンスデータはデータベースに保存され、次回以降は計算をスキップして高速表示
  - 正式データのみを使用して計算（仮終値データは除外）
  - デバッグ用に「全銘柄勝率再計算(debug用)」ボタンを追加

### v1.11.1 (2025-12-17)
- **スクリーニング条件「直近2日が5MAの上で陽線」の修正**
  - DBにある最新日付（正式データ）とその前日で判定するように修正
  - 仮終値データ（is_temporary_close=1）を除外し、正式データのみを使用
  - 当日データが補完されていても、DBの正式データで判定されるようになりました
  - これにより、DBの最新日付が陰線の場合は正しく除外されるようになりました

### v1.11.0 (2025-12-14)
- **セクター資金流動分析機能の拡張**
  - 1銘柄あたり売買代金のグラフ表示機能を追加（銘柄数の偏りを補正した比較が可能）
  - 1銘柄あたり売買代金の移動平均グラフ表示機能を追加
  - セクター別登録銘柄数の表示機能を追加（タブを開いた時に自動表示）
  - セクター別登録銘柄数に業種をアコーディオン表示で追加
  - セクター行をダブルクリックで銘柄一覧を表示する機能を追加
  - 業種行をダブルクリックでセクター・業種の銘柄一覧を表示する機能を追加
  - セクター別登録銘柄数の欄の高さを自動調整（初期表示でセクター全体が表示されるように改善）

### v1.10.0 (2025-12-12)
- **銘柄一覧からの外部サイトリンク機能を追加**
  - DB銘柄一覧、セクター別銘柄一覧、スクリーニング結果一覧から、右クリックメニューで株探・バフェット・コードのサイトに遷移できるようになりました
  - 銘柄を右クリックして「株探で開く」または「バフェット・コードで開く」を選択すると、ブラウザで該当銘柄のページが開きます

### v1.9.0 (2025-12-12)
- 初期リリース
- JPX400データ収集機能
- テクニカルスクリーニング機能
- チャート表示機能
- 地合いスコア機能
- 自動実行スケジューラー
- セクター資金流動分析機能（市況タブ）

---

## ⭐ スターのお願い

このプロジェクトが役に立ったと感じていただけましたら、GitHubでスター（⭐）を付けていただけると、作者の励みになります！

---

## 💬 サポート

質問や不具合報告は、プロジェクトの管理者に連絡してください。

**トラブルが発生した場合：**
1. このREADMEの「よくある質問とトラブルシューティング」セクションを確認してください
2. エラーメッセージの内容をメモしておいてください
3. プロジェクトの管理者に連絡する際は、エラーメッセージと、どの作業をしていた時にエラーが出たかを伝えてください

---

## ⚠️ 免責事項（再掲）

**このアプリケーションを使用する際は、以下の免責事項を必ずお読みください。**

- このアプリケーションは投資判断の支援ツールであり、投資の推奨や助言を行うものではありません
- 実際の株式投資に関するすべての判断と行動は、**ユーザー自身の責任**において行ってください
- このアプリケーションを使用した結果、投資判断や取引によって生じた損害について、開発者および提供者は一切の責任を負いません
- 投資にはリスクが伴います。投資を行う前に、必ずご自身で十分な調査・検討を行い、リスクを理解した上で判断してください
- 過去のデータや分析結果が将来の投資成果を保証するものではありません

---

## 📄 ライセンス

このプロジェクトは [MIT License](LICENSE) の下で公開されています。

詳細は `LICENSE` ファイルを参照してください。
